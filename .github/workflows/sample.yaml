name : Deploymnt of argo cd applica
on :
  push :
    branches :
      - master
    paths:
      - 'app/**'
      - '.github/workflows/**' 
jobs:
  build:
    if: "!contains(github.event.head_commit.message, 'Update tag in Helm chart')"
    runs-on : ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: setup docker buildx
      uses: docker/setup-buildx-action@v1

    - name: login to Dockerhub
      uses: docker/login-action@v3
      with:
        username: ${{secrets.DOCKERHUB_USERNAME}}
        password: ${{secrets.DOCKERHUB_TOKEN}}

    - name: Build and Push action
      uses: docker/build-push-action@v6
      with:
        context: ./app
        file: ./app/Dockerfile
        push: true
        tags: ${{secrets.DOCKERHUB_USERNAME}}/streamlit-app1:${{github.run_id}}

    - name: Print GitHub Run ID
      run: echo "Run ID:${{ github.run_id }}"

    - name: Scaning the docker image
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: "docker.io/${{ secrets.DOCKERHUB_USERNAME }}/streamlit-app1:${{ github.run_id }}"
        format: 'table'
        exit-code: '0'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'

  update-newtag-in-helm-chart:
    runs-on: ubuntu-latest
    needs: build
    steps :
    - name: checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{secrets.TOKEN}}
    - name: update tag in helm chat
      run: |
        sed -i 's/tag: .*/tag: "${{ github.run_id }}"/' helm-rep0/python-crud-app/values.yaml
    - name: push the image tag
      run: |
        git config --global user.email "rocky16715@gmail.com"
        git config --global user.name  "rockrakesh123"
        git add helm-rep0/python-crud-app/values.yaml
        git commit -m "Update tag in Helm chart"
        git push